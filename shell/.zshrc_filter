#!/bin/zsh
# FILTER_COMMAND='peco'
alias filter='eval ${FILTER_COMMAND}'

if [ -z "$FILTER_COMMAND" ]; then
  echo "FILTER_COMMAND variable is empty;"
  return;
fi

# http://www.pupha.net/archives/2267/
function filter_select_history() {
  local cmd=`history -500 | tail -r | filter | cut -d ' ' -f 1`
  if [ "${cmd}" != "" ]; then
    r ${cmd}
    return 0;
  fi
  return -1;
}
zle -N filter_select_history
alias fhist='filter_select_history'
bindkey '^r' filter_select_history

alias -g F='| filter'

# http://stillpedant.hatenablog.com/entry/percol-cd-history
typeset -U chpwd_functions
export CD_HISTORY_FILE=${HOME}/.cd_history_file # cd 履歴の記録先ファイル
function chpwd_record_history() {
  echo $PWD >> ${CD_HISTORY_FILE}
}
chpwd_functions=($chpwd_functions chpwd_record_history)

  # filter toolを使って cd 履歴の中からディレクトリを選択
  # 過去の訪問回数が多いほど選択候補の上に来る
function filter_get_destination_from_history() {
  sort ${CD_HISTORY_FILE} | uniq -c | sort -r | \
  sed -e 's/^[ ]*[0-9]*[ ]*//' | \
  sed -e s"/^${HOME//\//\\/}/~/" | \
  filter | xargs echo
}

# filter tool を使って cd 履歴の中からディレクトリを選択し cd するウィジェット
function filter_cd_history() {
  local destination=$(filter_get_destination_from_history)
  if [ "${destination}" != "" ]; then
    cd ${destination/#\~/${HOME}}
    print -s cd ${destination/#\~/${HOME}}
    # print -z cd ${destination/#\~/${HOME}}
    # zle -N reset-prompt
    return 0;
  fi
  return -1;
}
zle -N filter_cd_history
alias fcd='filter_cd_history'

# filter tool を使って cd 履歴の中からディレクトリを選択し，現在のカーソル位置に挿入するウィジェット
# function filter_insert_history() {
# local destination=$(filter_get_destination_from_history)
# if [ $? -eq 0 ]; then
#   local new_left="${LBUFFER} ${destination} "
#   BUFFER=${new_left}${RBUFFER}
#   CURSOR=${#new_left}
# fi
# zle -N reset-prompt
# }
# zle -N filter_insert_history
# alias pins='filter_insert_history'
# }}}


alias fgco='filter_git_command git checkout'
alias fgcob='fgco -b'
alias fgmg='filter_git_command git merge'
alias fgmgs='pgmg --squash'
alias fgpl='filter_git_command git pull origin'
alias fgps='filter_git_command git push origin'
alias fgbd='filter_git_command git branch -d'
alias fgbD='filter_git_command git branch -D'
alias fgb='git branch -a | filter'
alias fgbd_remote='filter_git_command git push --delete origin'
alias fgrb='filter_git_command git pull --rebase origin'
alias fgl='filter_git_command git log'
alias fglp='pgl -p'
alias fgd='filter_git_command git diff'

alias fls='ls -AaR | filter'
alias ffind='find -L . -name "*" | filter'
alias fps='ps aux | filter'
alias fkill='ps ax | filter | awk "{ print $1 }" | xargs kill'
alias fopen='pfind | xargs open'
alias fless='pfind | xargs less'
# http://qiita.com/itkrt2y/items/0671d1f48e66f21241e2
alias fghq='cd $(ghq root)/$(ghq list | filter)'

function fcat(){
  cat -n $@ | filter
}

# Gitのブランチをfilter toolで扱えるように整形
function br_fmt(){
  git branch -a | filter | xargs echo | sed -e 's/\*//' | sed -e 's/remotes\/origin\///'
}

function filter_git_command(){
  # local br=$(br_fmt)
  local cmd="$@ $(br_fmt)"
  eval $cmd
	if test $? -ne 0
	then
		return 1
	fi
  print -s $cmd
}

# filter tool git show file
function fgsf(){
 local temp=`br_fmt | xargs echo`
 git show "${temp}":"$@"
}

# filter tool git checkout file
function fgcof(){
 local temp=`br_fmt | xargs echo`
 gco "${temp}" -- "$@"
}

# filter tool git checkout directory
function fgcod(){
 local temp=`br_fmt | xargs echo`
 gco "${temp}" "$@"
}

function br_fmt_remote(){
  br_fmt | xargs echo | awk '{printf("%s%s\n", "remotes/origin/", $0)}'
}

function fgmg-remote(){
  br_fmt_remote | xargs git merge
}
function fgmgs-remote(){
  br_fmt_remote | xargs git merge --squash
}
function fgl-remote(){
  br_fmt_remote | xargs git log
}
function fglp-remote(){
  br_fmt_remote | xargs git log -p
}
function fglst-remote(){
  br_fmt_remote | xargs git log --stat
}
function fgd-remote(){
  br_fmt_remote | xargs git diff
}
function fgdn-remote(){
  br_fmt_remote | xargs git diff --name-status
}
